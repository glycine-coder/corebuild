<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªå­¦ç¿’ã‚µã‚¤ãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ³ãƒˆã¨ã—ã¦æ—¥æœ¬èªè¡¨ç¤ºã«é©ã—ãŸInterã‚’è¨­å®š */
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        /* ç”»é¢å…¨ä½“ã«ãƒ•ã‚£ãƒƒãƒˆã—ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç™ºç”Ÿã•ã›ãªã„ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .h-screen-no-scroll { height: 100vh; overflow: hidden; }
        .word-button { transition: all 0.2s; }
        .word-button:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .selected { opacity: 0.5; pointer-events: none; }
        .card-enter-active, .card-leave-active { transition: opacity 0.3s ease; }
        .card-enter-from, .card-leave-to { opacity: 0; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981',
                        'danger': '#ef4444',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 h-screen-no-scroll flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl flex flex-col h-full md:h-5/6 overflow-hidden">

        <header id="app-header" class="p-6 bg-primary text-white rounded-t-xl shadow-lg flex flex-col md:flex-row justify-between items-center hidden">
            <h1 class="text-2xl font-bold tracking-tight">é«˜é »åº¦å˜èªãƒªã‚¹ãƒ‹ãƒ³ã‚°å­¦ç¿’</h1>
            <div id="mode-selector" class="flex space-x-2 mt-3 md:mt-0">
                </div>
        </header>

        <main class="flex-grow p-6 flex flex-col space-y-4 overflow-y-auto">

            <div id="selection-screen" class="card-enter-active p-12 flex flex-col items-center justify-center h-full text-center">
                <h2 class="text-3xl font-extrabold text-gray-800 mb-8">å­¦ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
                
                <div class="space-y-6 w-full max-w-md">
                    <button onclick="selectCategory('travel')" class="w-full py-4 bg-yellow-500 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-yellow-600 transition-colors duration-200 transform hover:scale-[1.02]">
                        âœˆï¸ æ—…è¡Œç”¨è‹±èª
                    </button>

                    <button onclick="selectCategory('high_school')" class="w-full py-4 bg-green-500 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-green-600 transition-colors duration-200 transform hover:scale-[1.02]">
                        ğŸ“š é«˜æ ¡å—é¨“
                    </button>
                    
                    <button onclick="selectCategory('common_test')" class="w-full py-4 bg-primary text-white text-xl font-bold rounded-xl shadow-lg hover:bg-indigo-600 transition-colors duration-200 transform hover:scale-[1.02]">
                        ğŸ“ å…±é€šãƒ†ã‚¹ãƒˆ
                    </button>
                </div>

                <div id="common-test-sub" class="mt-8 pt-6 border-t border-gray-200 w-full max-w-md hidden">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">å…±é€šãƒ†ã‚¹ãƒˆï¼šå­¦ç¿’å†…å®¹ã‚’é¸æŠ</h3>
                    <div class="flex space-x-4">
                        <button onclick="startLearning('common_test_listening')" class="flex-1 py-3 bg-red-500 text-white font-bold rounded-lg shadow hover:bg-red-600 transition-colors duration-200">
                            ãƒªã‚¹ãƒ‹ãƒ³ã‚°
                        </button>
                        <button onclick="startLearning('common_test_reading')" class="flex-1 py-3 bg-blue-500 text-white font-bold rounded-lg shadow hover:bg-blue-600 transition-colors duration-200">
                            ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="learning-screen" class="hidden flex-grow flex flex-col space-y-4">
                
                <div class="text-center text-sm text-gray-500 mb-4">
                    <span id="sentence-id" class="font-mono bg-gray-100 px-2 py-1 rounded-md">ID: -</span>
                    <span id="sentence-year" class="ml-4 px-2 py-1 rounded-md text-primary font-semibold">å‡ºé¡Œå¹´åº¦: -</span>
                    <span id="current-category" class="ml-4 px-2 py-1 rounded-md text-gray-600 font-semibold">ã‚«ãƒ†ã‚´ãƒª: -</span>
                </div>
    
                <div id="english-display-card" class="bg-indigo-50 p-6 rounded-xl shadow-inner min-h-[100px] flex items-center justify-center transition-all duration-300">
                    <p id="english-text" class="text-xl md:text-2xl font-bold text-gray-800 text-center select-none">
                        å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„
                    </p>
                </div>
    
                <div id="translation-card" class="bg-white p-4 border border-gray-200 rounded-xl shadow min-h-[60px] transition-all duration-300 hidden">
                    <p class="text-sm font-semibold text-gray-600 mb-1">å’Œè¨³</p>
                    <p id="japanese-text" class="text-lg text-gray-700">
                        -
                    </p>
                </div>
    
                <div id="scramble-ui" class="space-y-4 hidden">
                    <div class="p-4 bg-yellow-100 rounded-xl border-dashed border-2 border-yellow-300 min-h-[80px]">
                        <p class="text-sm font-semibold text-yellow-700 mb-1">è§£ç­”æ§‹ç¯‰ã‚¨ãƒªã‚¢</p>
                        <div id="answer-area" class="flex flex-wrap gap-2">
                            </div>
                    </div>
    
                    <div class="p-4 bg-white rounded-xl shadow-md border-t border-gray-200">
                        <p class="text-sm font-semibold text-gray-600 mb-2">å˜èªã‚’é¸æŠã—ã¦æ­£ã—ã„è‹±æ–‡ã‚’å®Œæˆã•ã›ã‚ˆã†</p>
                        <div id="scrambled-words-area" class="flex flex-wrap gap-2">
                            </div>
                    </div>
    
                    <div class="flex justify-center space-x-4 pt-2">
                        <button id="check-answer-btn" onclick="checkScrambledAnswer()" class="px-6 py-2 bg-secondary text-white font-bold rounded-lg hover:bg-green-600 transition-colors shadow-md hidden">
                            è§£ç­”ãƒã‚§ãƒƒã‚¯
                        </button>
                        <button id="reset-scramble-btn" onclick="resetScramble()" class="px-6 py-2 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition-colors shadow-md hidden">
                            ãƒªã‚»ãƒƒãƒˆ
                        </button>
                    </div>
                </div>
    
                <div id="message-box" class="text-center py-2 text-lg font-semibold hidden rounded-lg"></div>
            </div>

        </main>

        <footer id="app-footer" class="p-6 bg-gray-100 rounded-b-xl border-t border-gray-200 flex justify-between items-center flex-wrap hidden">
            <div class="flex space-x-2">
                <button onclick="navigate(-1)" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                    &lt; å‰ã®æ–‡
                </button>
                <button onclick="navigate(1)" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                    æ¬¡ã®æ–‡ &gt;
                </button>
            </div>
            
            <button onclick="showSelectionScreen()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´
            </button>

            <div class="flex space-x-3 mt-4 md:mt-0">
                <button id="toggle-translation-btn" onclick="toggleTranslation()" class="px-6 py-2 bg-indigo-500 text-white font-bold rounded-lg hover:bg-indigo-600 transition-colors shadow-md hidden">
                    å’Œè¨³ã‚’è¡¨ç¤º
                </button>

                <button id="play-audio-btn" onclick="playAudio()" class="px-6 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition-colors shadow-md flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    éŸ³å£°å†ç”Ÿ
                </button>
            </div>
        </footer>

    </div>

<script>
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨å®šæ•° ---
    let DB = []; 
    let currentMode = 1;
    let currentSentenceIndex = 0;
    let isTranslationVisible = false;
    let correctWords = []; 
    let scrambledWords = []; 
    let answerSequence = []; 
    let currentCategory = ''; // æ–°ã—ã„ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°: ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªã‚’ä¿æŒ

    const JSON_MAP = {
        'travel': { path: './data/travel_sentences.json', name: 'æ—…è¡Œç”¨è‹±èª' },
        'high_school': { path: './data/high_school_entrance_sentences.json', name: 'é«˜æ ¡å—é¨“' },
        'common_test_listening': { path: './data/common_test_listening_sentences.json', name: 'å…±é€šãƒ†ã‚¹ãƒˆ (ãƒªã‚¹ãƒ‹ãƒ³ã‚°)' },
        'common_test_reading': { path: './data/common_test_reading_sentences.json', name: 'å…±é€šãƒ†ã‚¹ãƒˆ (ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°)' },
    };

    // --- DOMè¦ç´ ã®å‚ç…§ ---
    const englishTextEl = document.getElementById('english-text');
    const japaneseTextEl = document.getElementById('japanese-text');
    const translationCardEl = document.getElementById('translation-card');
    const toggleTranslationBtn = document.getElementById('toggle-translation-btn');
    const englishDisplayCardEl = document.getElementById('english-display-card');
    const scrambledWordsAreaEl = document.getElementById('scrambled-words-area');
    const answerAreaEl = document.getElementById('answer-area');
    const scrambleUiEl = document.getElementById('scramble-ui');
    const playAudioBtn = document.getElementById('play-audio-btn');
    const messageBoxEl = document.getElementById('message-box');
    const checkAnswerBtn = document.getElementById('check-answer-btn');
    const resetScrambleBtn = document.getElementById('reset-scramble-btn');
    const selectionScreenEl = document.getElementById('selection-screen'); // æ–°è¦
    const learningScreenEl = document.getElementById('learning-screen'); // æ–°è¦
    const commonTestSubEl = document.getElementById('common-test-sub'); // æ–°è¦
    const appHeaderEl = document.getElementById('app-header'); // æ–°è¦
    const appFooterEl = document.getElementById('app-footer'); // æ–°è¦
    const currentCategoryEl = document.getElementById('current-category'); // æ–°è¦

    // --- ã‚¢ãƒ—ãƒªåˆæœŸåŒ– ---
    window.onload = function() {
        showSelectionScreen(); // èµ·å‹•æ™‚ã¯ã‚«ãƒ†ã‚´ãƒªé¸æŠç”»é¢ã‹ã‚‰
    };
    
    /**
     * ã‚«ãƒ†ã‚´ãƒªé¸æŠç”»é¢ã‚’è¡¨ç¤ºã—ã€å­¦ç¿’ç”»é¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
     */
    function showSelectionScreen() {
        selectionScreenEl.classList.remove('hidden');
        learningScreenEl.classList.add('hidden');
        appHeaderEl.classList.add('hidden');
        appFooterEl.classList.add('hidden');
        commonTestSubEl.classList.add('hidden'); // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚‚ä¸€æ—¦éè¡¨ç¤º
        englishTextEl.textContent = 'å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„'; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆ
        
        // æ—¢å­˜ã®è¦ç´ ã‚’å‚ç…§ã—ã¦ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’å†é…ç½®ã™ã‚‹
        const modeSelector = document.getElementById('mode-selector');
        modeSelector.innerHTML = `
            <button onclick="changeMode(1)" id="mode-1" class="mode-tab bg-primary border-2 border-white text-white px-4 py-2 rounded-lg font-medium text-sm transition duration-200 hover:bg-white hover:text-primary">
                â‘  è‹±æ–‡å…ˆè¡Œ
            </button>
            <button onclick="changeMode(2)" id="mode-2" class="mode-tab bg-primary border-2 border-white text-white px-4 py-2 rounded-lg font-medium text-sm transition duration-200 hover:bg-white hover:text-primary">
                â‘¡ éŸ³å£°å…ˆè¡Œ
            </button>
            <button onclick="changeMode(3)" id="mode-3" class="mode-tab bg-primary border-2 border-white text-white px-4 py-2 rounded-lg font-medium text-sm transition duration-200 hover:bg-white hover:text-primary">
                â‘¢ ä¸¦ã¹æ›¿ãˆ
            </button>
        `;
    }

    /**
     * ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
     * @param {string} category - é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã‚­ãƒ¼
     */
    function selectCategory(category) {
        if (category === 'common_test') {
            // å…±é€šãƒ†ã‚¹ãƒˆã®å ´åˆã¯ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚’è¡¨ç¤º
            commonTestSubEl.classList.remove('hidden');
        } else {
            // ãã‚Œä»¥å¤–ã®å ´åˆã¯å³åº§ã«å­¦ç¿’é–‹å§‹
            startLearning(category);
        }
    }
    
    /**
     * å­¦ç¿’ã‚’é–‹å§‹ã—ã€DBã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
     * @param {string} key - JSON_MAPã®ã‚­ãƒ¼ï¼ˆe.g., 'travel', 'common_test_listening'ï¼‰
     */
    async function startLearning(key) {
        const config = JSON_MAP[key];
        if (!config) {
            showMessage('ã‚¨ãƒ©ãƒ¼: ä¸æ­£ãªã‚«ãƒ†ã‚´ãƒªãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚', 'danger');
            return;
        }

        // UIã®åˆ‡ã‚Šæ›¿ãˆ
        selectionScreenEl.classList.add('hidden');
        learningScreenEl.classList.remove('hidden');
        appHeaderEl.classList.remove('hidden');
        appFooterEl.classList.remove('hidden');
        commonTestSubEl.classList.add('hidden'); // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã¯éè¡¨ç¤ºã«æˆ»ã™
        
        currentCategory = config.name;
        currentCategoryEl.textContent = `ã‚«ãƒ†ã‚´ãƒª: ${config.name}`;
        
        try {
            englishTextEl.textContent = `${config.name}ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...`;

            const response = await fetch(config.path); 
            if (!response.ok) {
                // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯HTTPã‚¨ãƒ©ãƒ¼ã®å ´åˆ
                throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ‘ã‚¹: ${config.path}`);
            }
            
            DB = await response.json(); 

            if (DB.length === 0) {
                englishTextEl.textContent = `${config.name} ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`;
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‰ã€åˆæœŸãƒ¢ãƒ¼ãƒ‰ã§å­¦ç¿’é–‹å§‹
            currentSentenceIndex = 0; // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            changeMode(1); // åˆæœŸãƒ¢ãƒ¼ãƒ‰ï¼ˆè‹±æ–‡å…ˆè¡Œï¼‰ã§é–‹å§‹
        } catch (error) {
            console.error("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
            englishTextEl.textContent = `ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n${error.message}`;
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚«ãƒ†ã‚´ãƒªé¸æŠç”»é¢ã«æˆ»ã‚‹ã“ã¨ã‚’ä¿ƒã™
            showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚«ãƒ†ã‚´ãƒªã‚’å¤‰æ›´ã™ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'danger');
        }
    }


    /**
     * å˜èªä¸¦ã¹æ›¿ãˆã®ãŸã‚ã«è‹±æ–‡ã‚’æ•´å½¢ã—ã€å˜èªé…åˆ—ã‚’ç”Ÿæˆã™ã‚‹
     * @param {string} sentence - å‡¦ç†ã™ã‚‹è‹±æ–‡
     * @returns {string[]} å˜èªï¼ˆå¥èª­ç‚¹ã‚’å«ã‚€ï¼‰ã®é…åˆ—
     */
    function tokenizeSentence(sentence) {
        // ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ†å‰²ã—ãŸå¾Œã€å¥èª­ç‚¹ã‚’åˆ†é›¢ã™ã‚‹å‡¦ç†ã¯è¤‡é›‘ã«ãªã‚‹ãŸã‚ã€
        // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§å˜èªã‚’æŠ½å‡ºã—ã€å¥èª­ç‚¹ã¯å˜èªã«å«ã‚ãŸã¾ã¾æ‰±ã„ã¾ã™ã€‚
        // ï¼ˆä¾‹: 'rainy.' ã¯ä¸€ã¤ã®è¦ç´ ã¨ã—ã¦æ‰±ã†ï¼‰
        const words = sentence.trim().replace(/\n/g, ' ').split(/\s+/).filter(w => w.length > 0);
        return words;
    }

    /**
     * ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
     * @param {number} mode - 1, 2, or 3
     */
    function changeMode(mode) {
        // DBãŒã¾ã ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
        if (DB.length === 0) return;

        currentMode = mode;
        isTranslationVisible = false;

        // å…±é€šè¦ç´ ã®è¡¨ç¤º/éè¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
        translationCardEl.classList.add('hidden');
        toggleTranslationBtn.classList.add('hidden');
        scrambleUiEl.classList.add('hidden');
        checkAnswerBtn.classList.add('hidden');
        resetScrambleBtn.classList.add('hidden');
        messageBoxEl.classList.add('hidden');
        
        // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
        document.querySelectorAll('.mode-tab').forEach(btn => {
            btn.classList.remove('bg-white', 'text-primary');
            btn.classList.add('bg-primary', 'text-white');
        });
        document.getElementById(`mode-${mode}`).classList.remove('bg-primary', 'text-white');
        document.getElementById(`mode-${mode}`).classList.add('bg-white', 'text-primary');


        // ãƒ¢ãƒ¼ãƒ‰å›ºæœ‰ã®UIè¨­å®š
        if (mode === 1) {
            // ãƒ¢ãƒ¼ãƒ‰1: è‹±æ–‡å…ˆè¡Œ
            englishTextEl.classList.remove('blur-sm');
            toggleTranslationBtn.textContent = 'å’Œè¨³ã‚’è¡¨ç¤º';
            toggleTranslationBtn.classList.remove('hidden');
        } else if (mode === 2) {
            // ãƒ¢ãƒ¼ãƒ‰2: éŸ³å£°å…ˆè¡Œ
            englishTextEl.classList.add('blur-sm'); // è‹±æ–‡ã‚’ã¼ã‹ã—ã¦éš ã™
            toggleTranslationBtn.textContent = 'è‹±æ–‡ãƒ»å’Œè¨³ã‚’è¡¨ç¤º';
            toggleTranslationBtn.classList.remove('hidden');
        } else if (mode === 3) {
            // ãƒ¢ãƒ¼ãƒ‰3: ä¸¦ã¹æ›¿ãˆ
            scrambleUiEl.classList.remove('hidden');
            checkAnswerBtn.classList.remove('hidden');
            resetScrambleBtn.classList.remove('hidden');
            setupScrambleMode();
        }

        loadSentence(currentSentenceIndex);
    }

    /**
     * ç¾åœ¨ã®æ–‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’UIã«èª­ã¿è¾¼ã‚€
     * @param {number} index - DBé…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
     */
    function loadSentence(index) {
        if (DB.length === 0) return; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        
        currentSentenceIndex = (index + DB.length) % DB.length;
        const data = DB[currentSentenceIndex];

        document.getElementById('sentence-id').textContent = `ID: ${data.id}`;
        document.getElementById('sentence-year').textContent = `å‡ºé¡Œå¹´åº¦: ${data.year || 'N/A'}`; // yearãŒãªã„å ´åˆã‚’è€ƒæ…®

        // å…±é€šè¡¨ç¤ºã®æ›´æ–°
        englishTextEl.innerHTML = data.en.replace(/\n/g, '<br>');
        japaneseTextEl.innerHTML = data.ja.replace(/\n/g, '<br>');

        // å’Œè¨³ã®è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ (ãƒ¢ãƒ¼ãƒ‰1, 2)
        if (currentMode === 1 || currentMode === 2) {
            isTranslationVisible = false;
            updateTranslationVisibility();
        }

        // ãƒ¢ãƒ¼ãƒ‰3ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        if (currentMode === 3) {
            setupScrambleMode();
        } else {
            // ãƒ¢ãƒ¼ãƒ‰1ã¨2ã§ã¯è‹±æ–‡ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
            englishTextEl.classList.remove('italic', 'text-gray-400');
            if (currentMode === 1) {
                englishTextEl.classList.remove('blur-sm');
            } else if (currentMode === 2) {
                englishTextEl.classList.add('blur-sm');
            }
        }
        
        hideMessage();
    }

    /**
     * å’Œè¨³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ (ãƒ¢ãƒ¼ãƒ‰ 1, 2)
     */
    function toggleTranslation() {
        isTranslationVisible = !isTranslationVisible;
        updateTranslationVisibility();

        if (currentMode === 2 && isTranslationVisible) {
            // ãƒ¢ãƒ¼ãƒ‰2ã§è¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€è‹±æ–‡ã®ã¼ã‹ã—ã‚’è§£é™¤
            englishTextEl.classList.remove('blur-sm');
        }
    }
    
    /**
     * å’Œè¨³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°ã—ã€ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´ã™ã‚‹
     */
    function updateTranslationVisibility() {
        if (isTranslationVisible) {
            translationCardEl.classList.remove('hidden');
            if (currentMode === 2) {
                 toggleTranslationBtn.textContent = 'è‹±æ–‡ãƒ»å’Œè¨³ã‚’éè¡¨ç¤º';
            } else {
                toggleTranslationBtn.textContent = 'å’Œè¨³ã‚’éè¡¨ç¤º';
            }
        } else {
            translationCardEl.classList.add('hidden');
            if (currentMode === 2) {
                 toggleTranslationBtn.textContent = 'è‹±æ–‡ãƒ»å’Œè¨³ã‚’è¡¨ç¤º';
            } else {
                toggleTranslationBtn.textContent = 'å’Œè¨³ã‚’è¡¨ç¤º';
            }
        }
    }


    /**
     * éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ç”Ÿã™ã‚‹
     */
    function playAudio() {
        if (DB.length === 0) return;
        const data = DB[currentSentenceIndex];
        // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `audio/sentence0003.mp3` ã®å½¢å¼ã§æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã¨ä»®å®šã—ã¾ã™ã€‚
        const audioPath = `./audio/${data.id}.mp3`;
        
        const audio = new Audio(audioPath);
        audio.play().catch(e => {
            console.error("éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„: ", audioPath, e);
            showMessage("éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¾ãŸã¯å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 'danger');
        });

        // ãƒ¢ãƒ¼ãƒ‰2ã®å ´åˆã€éŸ³å£°å†ç”Ÿå¾Œã«è‹±æ–‡ã®ã¼ã‹ã—ã‚’è§£é™¤ã—ãªã„ï¼ˆãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã§æ“ä½œã™ã‚‹ãŸã‚ï¼‰
        if (currentMode === 2 && !isTranslationVisible) {
            // éŸ³å£°ãŒæµã‚ŒãŸã“ã¨ã‚’ç¤ºã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™ï¼ˆä»»æ„ï¼‰
             showMessage("éŸ³å£°ãŒå†ç”Ÿã•ã‚Œã¾ã—ãŸã€‚è‹±æ–‡ã®æ§‹æˆã‚’è€ƒãˆã¾ã—ã‚‡ã†ã€‚", 'secondary');
        } else if (currentMode === 3) {
            // ãƒ¢ãƒ¼ãƒ‰3ã®å ´åˆã€éŸ³å£°å†ç”Ÿå¾Œã«å˜èªä¸¦ã¹æ›¿ãˆã‚’é–‹å§‹
             showMessage("éŸ³å£°ãŒå†ç”Ÿã•ã‚Œã¾ã—ãŸã€‚å˜èªã‚’ä¸¦ã¹æ›¿ãˆã¦ãã ã•ã„ã€‚", 'secondary');
        }
    }

    /**
     * æ¬¡ã¾ãŸã¯å‰ã®æ–‡ã¸ç§»å‹•ã™ã‚‹
     * @param {number} direction - 1 for next, -1 for previous
     */
    function navigate(direction) {
        if (DB.length === 0) return;
        let newIndex = currentSentenceIndex + direction;
        loadSentence(newIndex);
    }
    
    // --- ãƒ¢ãƒ¼ãƒ‰ 3 (ä¸¦ã¹æ›¿ãˆ) ã®ãƒ­ã‚¸ãƒƒã‚¯ ---

    /**
     * ãƒ¢ãƒ¼ãƒ‰3ã®åˆæœŸè¨­å®šã¨å˜èªã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚’è¡Œã†
     */
    function setupScrambleMode() {
        const data = DB[currentSentenceIndex];
        
        // è‹±æ–‡è¡¨ç¤ºã‚¨ãƒªã‚¢ã«ã¯åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        englishTextEl.textContent = 'ä¸¦ã¹æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ï¼šä»¥ä¸‹ã®å˜èªã‚’æ­£ã—ã„é †ç•ªã«çµ„ã¿æ›¿ãˆã¦ãã ã•ã„ã€‚';
        englishTextEl.classList.remove('blur-sm'); // è‹±æ–‡ã¯å¸¸ã«éè¡¨ç¤º

        // æ­£ã—ã„å˜èªé…åˆ—ã‚’ç”Ÿæˆ
        correctWords = tokenizeSentence(data.en);
        
        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚ŒãŸå˜èªé…åˆ—ã‚’ç”Ÿæˆ
        scrambledWords = [...correctWords];
        shuffleArray(scrambledWords);
        
        answerSequence = []; // ãƒ¦ãƒ¼ã‚¶ãƒ¼è§£ç­”ã‚’ãƒªã‚»ãƒƒãƒˆ
        
        renderScrambledWords();
        renderAnswerArea();
        hideMessage();
    }
    
    /**
     * é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ï¼ˆFisher-Yatesã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰
     * @param {Array} array - ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹é…åˆ—
     */
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    /**
     * ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚ŒãŸå˜èªãƒœã‚¿ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
     */
    function renderScrambledWords() {
        scrambledWordsAreaEl.innerHTML = '';
        scrambledWords.forEach((word, index) => {
            const button = document.createElement('button');
            button.className = 'word-button bg-primary text-white text-sm md:text-base font-medium px-3 py-1 rounded-full shadow-md hover:bg-indigo-600 transition-colors duration-200';
            button.textContent = word;
            button.dataset.index = index;
            button.onclick = () => selectWord(word, index);
            scrambledWordsAreaEl.appendChild(button);
        });
    }

    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼è§£ç­”ã‚¨ãƒªã‚¢ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
     */
    function renderAnswerArea() {
        answerAreaEl.innerHTML = '';
        answerSequence.forEach((item, index) => {
            const span = document.createElement('span');
            // å›ç­”ã‚¨ãƒªã‚¢ã«è¡¨ç¤ºã™ã‚‹å˜èªã¯ã€ã‚¯ãƒªãƒƒã‚¯ã§æˆ»ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
            span.className = 'answer-word bg-white text-gray-800 text-sm md:text-base px-3 py-1 rounded-full shadow border border-gray-300 cursor-pointer';
            span.textContent = item.word;
            // ã©ã®å…ƒã®ãƒœã‚¿ãƒ³ã«å¯¾å¿œã—ã¦ã„ãŸã‹ã‚’ç¤ºã™ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒ
            span.dataset.originalIndex = item.originalIndex; 
            span.onclick = () => deselectWord(index);
            answerAreaEl.appendChild(span);
        });
        
        // æ­£ã—ã„é †ç•ªã®è‹±æ–‡ã‚’è¡¨ç¤ºã™ã‚‹English Display Cardã¯ç©ºã«ã—ã¦ãŠã
        englishTextEl.classList.add('italic', 'text-gray-400');
        if (answerSequence.length === 0) {
            englishTextEl.textContent = 'ä¸¦ã¹æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ï¼šå˜èªã‚’é¸æŠã—ã¦ãã ã•ã„';
        } else {
            englishTextEl.textContent = answerSequence.map(item => item.word).join(' ');
        }
    }

    /**
     * ã‚·ãƒ£ãƒƒãƒ•ãƒ«å˜èªã‚’é¸æŠã—ã¦è§£ç­”ã‚¨ãƒªã‚¢ã«è¿½åŠ ã™ã‚‹
     * @param {string} word - é¸æŠã•ã‚ŒãŸå˜èª
     * @param {number} originalIndex - ã‚·ãƒ£ãƒƒãƒ•ãƒ«é…åˆ—å†…ã®å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
     */
    function selectWord(word, originalIndex) {
        const button = scrambledWordsAreaEl.querySelector(`[data-index="${originalIndex}"]`);
        if (button) {
            // ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã€ã‚¯ãƒªãƒƒã‚¯ä¸èƒ½ã«ã™ã‚‹
            button.classList.add('selected');
        }

        answerSequence.push({ word, originalIndex });
        renderAnswerArea();
        hideMessage();
    }
    
    /**
     * è§£ç­”ã‚¨ãƒªã‚¢ã®å˜èªã‚’å‰Šé™¤ã—ã€ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚¨ãƒªã‚¢ã«æˆ»ã™
     * @param {number} answerIndex - è§£ç­”é…åˆ—å†…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
     */
    function deselectWord(answerIndex) {
        const [removedItem] = answerSequence.splice(answerIndex, 1);
        
        // å…ƒã®ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
        const button = scrambledWordsAreaEl.querySelector(`[data-index="${removedItem.originalIndex}"]`);
        if (button) {
            button.classList.remove('selected');
        }
        
        renderAnswerArea();
        hideMessage();
    }
    
    /**
     * ä¸¦ã¹æ›¿ãˆã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
     */
    function resetScramble() {
        setupScrambleMode(); // å†åº¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ãƒªã‚»ãƒƒãƒˆ
        showMessage("ä¸¦ã¹æ›¿ãˆãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚", 'gray');
    }

    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸¦ã¹æ›¿ãˆçµæœã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤ºã™ã‚‹
     */
    function checkScrambledAnswer() {
        if (answerSequence.length === 0) {
            showMessage("å˜èªã‚’é¸æŠã—ã¦è‹±æ–‡ã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„ã€‚", 'danger');
            return;
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã‚’æ–‡å­—åˆ—ã¨ã—ã¦çµåˆ
        const userSentence = answerSequence.map(item => item.word).join(' ');
        const correctSentence = correctWords.join(' ');
        
        // æ¯”è¼ƒã®ãŸã‚ã«æ­£è¦åŒ–ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚’ä¸€ã¤ã«ã—ã€å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤ï¼‰
        const normalizedUser = userSentence.replace(/\s+/g, ' ').trim();
        const normalizedCorrect = correctSentence.replace(/\s+/g, ' ').trim();

        if (normalizedUser === normalizedCorrect) {
            showMessage("æ­£è§£ã§ã™ï¼ã‚ˆãã§ãã¾ã—ãŸï¼", 'secondary');
            
            // æ­£è§£ã®å ´åˆã€è‹±æ–‡è¡¨ç¤ºã‚¨ãƒªã‚¢ã«æ­£ã—ã„è‹±æ–‡ã‚’ã—ã£ã‹ã‚Šã¨è¡¨ç¤º
            englishTextEl.textContent = correctSentence;
            englishTextEl.classList.remove('italic', 'text-gray-400');
            
            // å’Œè¨³ã‚’è¡¨ç¤ºã™ã‚‹
            translationCardEl.classList.remove('hidden');

        } else {
            // ä¸æ­£è§£ã®å ´åˆã€ã©ã“ãŒé–“é•ã£ã¦ã„ã‚‹ã‹ã‚’æ¯”è¼ƒã—ã¦ãƒ’ãƒ³ãƒˆã‚’å‡ºã™ã“ã¨ã‚‚å¯èƒ½ã ãŒã€ã‚·ãƒ³ãƒ—ãƒ«ã«ä¸æ­£è§£è¡¨ç¤º
            showMessage("æ®‹å¿µï¼ã¾ã é–“é•ã£ã¦ã„ã¾ã™ã€‚ã‚‚ã†ä¸€åº¦éŸ³å£°ã‚’è´ã„ã¦è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚", 'danger');
        }
    }


    /**
     * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹
     * @param {string} text - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     * @param {string} type - 'secondary', 'danger', 'primary', 'gray' ãªã©
     */
    function showMessage(text, type) {
        messageBoxEl.textContent = text;
        messageBoxEl.className = `text-center py-2 px-4 text-lg font-semibold rounded-lg shadow-sm mt-4`;
        
        // ã‚«ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ã®è¨­å®š
        let bgColor, textColor;
        switch (type) {
            case 'secondary': bgColor = 'bg-green-200'; textColor = 'text-green-800'; break;
            case 'danger': bgColor = 'bg-red-200'; textColor = 'text-red-800'; break;
            case 'primary': bgColor = 'bg-blue-200'; textColor = 'text-blue-800'; break;
            case 'gray': bgColor = 'bg-gray-200'; textColor = 'text-gray-800'; break;
            default: bgColor = 'bg-yellow-200'; textColor = 'text-yellow-800'; break;
        }
        messageBoxEl.classList.add(bgColor, textColor);
        messageBoxEl.classList.remove('hidden');
    }

    /**
     * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’éè¡¨ç¤ºã«ã™ã‚‹
     */
    function hideMessage() {
        messageBoxEl.classList.add('hidden');
    }

</script>
</body>
</html>